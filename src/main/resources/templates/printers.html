<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Printer Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#007bff', /* Used for progress bar fill */
                        'secondary-blue': '#4c95eb', /* A slightly lighter blue for some accents */
                        'primary-green': '#28a745', /* Main button green */
                        'primary-green-hover': '#218838', /* Darker green on hover */
                        'soft-gray': '#f8f9fa', /* Lighter background for elements */
                        'dark-blue-600': '#2563eb', /* A deeper blue for search/clear icons */
                        'dark-gray-600': '#4b5563', /* A deeper gray for clear icons */
                    },
                    boxShadow: {
                        'custom-light': '0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.08)',
                        'custom-medium': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        'neumorphic': '6px 6px 12px #cbced1, -6px -6px 12px #ffffff', /* For sophisticated look */
                        'neumorphic-inner': 'inset 6px 6px 12px #cbced1, inset -6px -6px 12px #ffffff',
                    }
                }
            }
        }
    </script>
    <style>
        /* This style is dynamically updated by JavaScript for the circular progress */
        .progress-gradient {
            background: conic-gradient(var(--tw-primary-blue) var(--progress, 0%), transparent var(--progress, 0%));
            transition: background 0.1s linear; /* Smooth transition for progress bar */
        }

        /* Styles for sophisticated buttons */
        .sophisticated-button {
            border-radius: 9999px; /* Make it perfectly round */
            box-shadow: 3px 3px 6px rgba(0,0,0,0.1), -3px -3px 6px rgba(255,255,255,0.7); /* Soft shadow */
            transition: all 0.2s ease-in-out;
            border: none; /* Remove default border */
            width: 60px; /* Consistent size */
            height: 60px; /* Consistent size */
            display: flex; /* Ensure flex for icon/text centering */
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* Smaller padding */
            cursor: pointer; /* Explicitly set cursor pointer */
            position: relative; /* Needed for absolute positioning of progress overlay */
            overflow: hidden; /* Hide overflow of progress overlay */
            /* Removed flex-direction: column and font-size as text is now outside */
        }

        .sophisticated-button:hover {
            box-shadow: 2px 2px 4px rgba(0,0,0,0.1), -2px -2px 4px rgba(255,255,255,0.7); /* Smaller shadow on hover */
        }

        .sophisticated-button:active {
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1), inset -1px -1px 2px rgba(255,255,255,0.7); /* Inner shadow on click */
        }

        .sophisticated-button .icon-small {
            width: 2rem; /* Icon size */
            height: 2rem; /* Icon size */
            /* Removed margin-bottom as text is now outside */
            position: relative; /* Ensure icon is above progress overlay */
            z-index: 10; /* Bring icon to front */
        }

        /* The text is now a separate span below the button */
        .button-label {
            font-size: 0.75rem; /* Smaller text for labels */
            font-weight: 600; /* Semibold */
            color: #4a5568; /* A nice gray color */
            margin-top: 0.5rem; /* Space between button and text */
            text-align: center;
            line-height: 1; /* Compact line height */
        }

        .sophisticated-button.green {
            background-color: #e0f2e0; /* Light green background */
            color: #28a745; /* Green text/icon */
        }

        .sophisticated-button.purple {
            background-color: #efedfb; /* Light purple background */
            color: #6d28d9; /* Deep purple text/icon */
        }
        .sophisticated-button.red { /* New style for clear all filters button */
            background-color: #fcebeb; /* Light red background */
            color: #dc3545; /* Red text/icon */
        }

        /* Custom styles for the dropdown with icon */
        .select-wrapper {
            position: relative;
            display: inline-block; /* Ensure it takes only required width */
        }

        .select-wrapper select {
            /* Hide default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 2.5rem; /* Make space for the custom icon */
            background-image: none; /* Remove any default background image for arrow */
        }

        .select-wrapper::after {
            content: 'â–¼'; /* Unicode for a small downward-pointing triangle */
            font-size: 0.75rem; /* Adjust size as needed */
            color: #4b5563; /* Icon color */
            position: absolute;
            right: 0.75rem; /* Position from the right edge */
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none; /* Make sure clicks go through to the select */
        }
    </style>
</head>
<body class="font-sans antialiased bg-gradient-to-br from-blue-50 to-gray-100 min-h-screen flex items-center justify-center py-12">

<div class="w-full max-w-full mx-auto p-8 bg-white shadow-custom-medium rounded-xl border border-gray-200">

    <h2 class="text-4xl font-extrabold text-center text-gray-800 mb-8 tracking-tight">Network Printer Management</h2>

    <div class="flex flex-wrap items-end justify-center gap-6 mb-8 px-6 py-4 bg-soft-gray rounded-lg shadow-sm border border-gray-200">

        <div class="flex flex-col items-start gap-1">
            <label for="subnetPart1" class="block text-sm font-semibold text-gray-700 mb-1">Subnet Prefix (e.g., 192.168.1.)</label>
            <div class="flex space-x-1">
                <input type="number" id="subnetPart1" name="subnetPart1" value="10" min="1" max="255"
                       class="p-2.5 border border-gray-300 rounded-md bg-gray-50 focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm w-16 text-center"
                       placeholder="1-255"/>
                <span class="p-2.5 text-gray-600">.</span>
                <input type="number" id="subnetPart2" name="subnetPart2" value="50" min="1" max="255"
                       class="p-2.5 border border-gray-300 rounded-md bg-gray-50 focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm w-16 text-center"
                       placeholder="1-255"/>
                <span class="p-2.5 text-gray-600">.</span>
                <input type="number" id="subnetPart3" name="subnetPart3" value="95" min="1" max="255"
                       class="p-2.5 border border-gray-300 rounded-md bg-gray-50 focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm w-16 text-center"
                       placeholder="1-255"/>
                <span class="p-2.5 text-gray-600">.</span>
            </div>
        </div>

        <div class="flex flex-col items-center">
            <button type="submit" form="discoverForm" id="discoverButton"
                    class="sophisticated-button green">
                <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9.75 17.01M12 21.75C16.8913 21.75 20.75 17.8913 20.75 13C20.75 8.1087 16.8913 4.25 12 4.25C7.1087 4.25 3.25 8.1087 3.25 13C3.25 17.8913 7.1087 21.75 12 21.75ZM15.75 13C15.75 13.4142 15.4142 13.75 15 13.75H12.75V15.75C12.75 16.1642 12.4142 16.5 12 16.5C11.5858 16.5 11.25 16.1642 11.25 15.75V13.75H9C8.58579 13.75 8.25 13.4142 8.25 13C8.25 12.5858 8.58579 12.25 9 12.25H11.25V10C11.25 9.58579 11.5858 9.25 12 9.25C12.4142 9.25 12.75 9.58579 12.75 10V12.25H15C15.4142 12.25 15.75 12.5858 15.75 13Z"></path></svg>
                <div id="progressOverlay" class="absolute inset-0 rounded-full progress-gradient z-0"></div>
            </button>
            <span id="buttonText" class="button-label text-gray-700">Discover</span>
        </div>

        <div class="flex flex-col items-center">
            <button type="submit" form="refreshAllForm"
                    class="sophisticated-button purple">
                <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h-.582m0 0l-1.355-1.355M4 9h5m7.632-4.474l1.355-1.355M16 4v5h.582m0 0l1.355-1.355M16 9h5m-2.474 4.474a8.001 8.001 0 00-11.056 0"></path>
                </svg>
            </button>
            <span class="button-label text-gray-700">Refresh All</span>
        </div>

        <div class="flex flex-col items-center">
            <a href="/printers/download/excel"
               class="sophisticated-button green" style="text-decoration: none;">
                <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 10.5v6m0 0l-3-3m3 3l3-3m-9 3h6m-9-1.5a4.5 4.5 0 01-1.414 3.182A4.5 4.5 0 019 19.5h6a4.5 4.5 0 011.414-.414M12 21a9 9 0 100-18 9 9 0 000 18z"></path>
                </svg>
            </a>
            <span class="button-label text-gray-700">Export All</span>
        </div>

        <div class="flex flex-col items-start gap-1 p-4 bg-white rounded-lg shadow-inner mt-4 w-full">
            <label for="ipAddressesToExport" class="block text-sm font-semibold text-gray-700 mb-1">
                Export Specific Printers by IP Address (comma or newline separated):
            </label>
            <textarea id="ipAddressesToExport" rows="4"
                      class="w-full p-2.5 border border-gray-300 rounded-md bg-gray-50 focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm"
                      placeholder="e.g., 192.168.1.100, 192.168.1.101&#10;192.168.1.102"></textarea>
            <div class="flex flex-col items-center mt-3 w-full">
                <button type="button" id="exportSelectedButton"
                        class="sophisticated-button green w-24 h-24 sm:w-auto sm:h-auto px-6 py-3">
                    <svg class="icon-small" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 10.5v6m0 0l-3-3m3 3l3-3m-9 3h6m-9-1.5a4.5 4.5 0 01-1.414 3.182A4.5 4.5 0 019 19.5h6a4.5 4.5 0 011.414-.414M12 21a9 9 0 100-18 9 9 0 000 18z"></path>
                    </svg>
                </button>
                <span class="button-label text-gray-700 mt-2">Export Selected</span>
            </div>
        </div>
    </div>

    <div class="mb-8 p-6 bg-soft-gray border border-gray-200 rounded-lg shadow-sm">
        <form id="filterForm" th:action="@{/printers}" method="get" class="grid grid-cols-1 gap-6 items-end lg:grid-cols-2">
            <div class="lg:col-span-2">
                <label for="searchTerm" class="block text-sm font-semibold text-gray-700 mb-1">Search:</label>
                <div class="flex items-end gap-2">
                    <div class="relative flex-grow flex">
                        <div class="select-wrapper">
                            <select id="searchType" name="searchType" class="block w-fit p-2.5 border border-gray-300 rounded-l-md bg-gray-50 focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm">
                                <option value="name" th:selected="${searchType == 'name' or searchType == null}">Name</option>
                                <option value="ipAddress" th:selected="${searchType == 'ipAddress'}">IP Address</option>
                                <option value="serialNumber" th:selected="${searchType == 'serialNumber'}">Serial Number</option>
                                <option value="manufacturer" th:selected="${searchType == 'manufacturer'}">Manufacturer</option>
                                <option value="model" th:selected="${searchType == 'model'}">Model</option>
                            </select>
                        </div>
                        <input type="text" id="searchTerm" name="searchTerm" th:value="${searchTerm}" placeholder="Search by Name, IP, Serial No., Manufacturer or Model" oninput="toggleClearButton('searchTerm')" class="flex-grow p-2.5 border border-gray-300 rounded-r-md focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm"/>
                        <button type="button" id="clearSearch" onclick="clearInput('searchTerm')" class="ml-2 p-2.5 bg-gray-200 rounded-md text-dark-gray-600 hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm" style="display: none;">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="select-wrapper w-full">
                <label for="filterType" class="block text-sm font-semibold text-gray-700 mb-1">Filter by Quick Status:</label>
                <select id="filterType" name="filterType" onchange="toggleFilterInputs()" class="block w-full p-2.5 border border-gray-300 rounded-md bg-gray-50 focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm">
                    <option value="none" th:selected="${filterType == 'none' or filterType == null}">No Filter</option>
                    <option value="tonerLow" th:selected="${filterType == 'tonerLow'}">Toner &lt; 20%</option>
                    <option value="tonerMedium" th:selected="${filterType == 'tonerMedium'}">Toner 20-50%</option>
                    <option value="tonerHigh" th:selected="${filterType == 'tonerHigh'}">Toner &gt; 50%</option>
                    <option value="pagesLow" th:selected="${filterType == 'pagesLow'}">Pages &lt; 10k</option>
                    <option value="pagesMedium" th:selected="${filterType == 'pagesMedium'}">Pages 10k-50k</option>
                    <option value="pagesHigh" th:selected="${filterType == 'pagesHigh'}">Pages &gt; 50k</option>
                    <option value="lastRefresh24h" th:selected="${filterType == 'lastRefresh24h'}">Last Refresh &lt; 24h</option>
                    <option value="lastRefresh7d" th:selected="${filterType == 'lastRefresh7d'}">Last Refresh &lt; 7 days</option>
                    <option value="lastRefresh30d" th:selected="${filterType == 'lastRefresh30d'}">Last Refresh &lt; 30 days</option>
                </select>
            </div>

            <div id="tonerFilterGroup" class="relative" style="display: none;">
                <label for="minToner" class="block text-sm font-semibold text-gray-700 mb-1">Min Toner Level (%):</label>
                <input type="number" id="minToner" name="minToner" th:value="${minToner}" oninput="toggleClearButton('minToner')"
                       class="w-full p-2.5 border border-gray-300 rounded-md bg-gray-50 focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm"
                       min="0" max="100" placeholder="e.g., 20"/>
                <button type="button" id="clearMinToner" onclick="clearInput('minToner')" class="absolute right-2.5 bottom-2.5 p-1 bg-gray-200 rounded-md text-dark-gray-600 hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm" style="display: none;">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div id="pagesFilterGroup" class="relative" style="display: none;">
                <label for="minPages" class="block text-sm font-semibold text-gray-700 mb-1">Min Page Count:</label>
                <input type="number" id="minPages" name="minPages" th:value="${minPages}" oninput="toggleClearButton('minPages')"
                       class="w-full p-2.5 border border-gray-300 rounded-md bg-gray-50 focus:ring-secondary-blue focus:border-secondary-blue text-gray-800 transition duration-150 ease-in-out shadow-sm"
                       min="0" placeholder="e.g., 10000"/>
                <button type="button" id="clearMinPages" onclick="clearInput('minPages')" class="absolute right-2.5 bottom-2.5 p-1 bg-gray-200 rounded-md text-dark-gray-600 hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm" style="display: none;">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex gap-4 lg:col-span-2">
                <button type="submit"
                        class="flex-1 px-6 py-3 bg-primary-blue text-white font-semibold rounded-lg shadow-md hover:bg-secondary-blue transition duration-200 ease-in-out transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-secondary-blue focus:ring-opacity-50">
                    Apply Filters
                </button>
                <button type="button" onclick="clearAllFilters()"
                        class="sophisticated-button red flex-shrink-0 w-12 h-12 flex items-center justify-center p-0 rounded-full shadow-md hover:shadow-lg transition duration-200 ease-in-out">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </form>
    </div>


    <div class="bg-white shadow-custom-medium rounded-xl border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Toner Level</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Page Count</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manufacturer</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Refresh</th>
                    <th scope="col" class="relative px-6 py-3">
                        <span class="sr-only">Actions</span>
                    </th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr th:each="printer : ${printers}">
                    <td th:text="${printer.id}" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"></td>
                    <td th:text="${printer.ipAddress}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"></td>
                    <td th:text="${printer.name}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span th:if="${printer.tonerLevel != null}" th:text="${printer.tonerLevel + '%'}"></span>
                        <span th:if="${printer.tonerLevel == null}">N/A</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span th:if="${printer.pageCount != null}" th:text="${printer.pageCount}"></span>
                        <span th:if="${printer.pageCount == null}">N/A</span>
                    </td>
                    <td th:text="${printer.serialNumber}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"></td>
                    <td th:text="${printer.manufacturer}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"></td>
                    <td th:text="${printer.model}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        <span th:if="${printer.lastRefreshTime != null}" th:text="${#temporals.format(printer.lastRefreshTime, 'yyyy-MM-dd HH:mm:ss')}"></span>
                        <span th:if="${printer.lastRefreshTime == null}">N/A</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <form th:action="@{/printers/refresh/{id}(id=${printer.id})}" method="get" style="display: inline;">
                            <button type="submit" class="text-indigo-600 hover:text-indigo-900 ml-4">Refresh</button>
                        </form>
                        <form th:action="@{/printers/delete/{id}(id=${printer.id})}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this printer?');">
                            <button type="submit" class="text-red-600 hover:text-red-900 ml-4">Delete</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<form id="discoverForm" th:action="@{/discoverPrinters}" method="post" style="display: none;">
    <input type="hidden" name="subnetPrefix" id="hiddenSubnetPrefix"/>
</form>

<form id="refreshAllForm" th:action="@{/refreshAllPrinters}" method="get" style="display: none;"></form>

<script th:inline="javascript">
    /*<![CDATA[*/

    // Message handling
    const message = [[${message}]];
    if (message) {
        alert(message);
    }

    // Progress bar for discovery
    let progressInterval;
    const discoverButton = document.getElementById('discoverButton');
    const progressOverlay = document.getElementById('progressOverlay');
    const buttonText = document.getElementById('buttonText');

    function updateProgressBar(progress) {
        if (progressOverlay) {
            progressOverlay.style.background = `conic-gradient(var(--tw-primary-blue) ${progress}%, transparent ${progress}%)`;
        }
    }

    function getDiscoveryProgress() {
        fetch('/discoveryProgress')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.inProgress) {
                    if (discoverButton) discoverButton.disabled = true;
                    if (buttonText) {
                        if (data.progress > 0 && data.progress < 100) {
                            buttonText.textContent = `${data.progress}%`;
                        } else if (data.progress === 0) {
                            buttonText.textContent = 'Starting...';
                        }
                    }
                    updateProgressBar(data.progress);
                } else {
                    clearInterval(progressInterval);
                    resetDiscoveryUI();
                    // Optionally refresh the page or part of it to show new printers
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error fetching discovery progress:', error);
                clearInterval(progressInterval);
                resetDiscoveryUI();
            });
    }

    function resetDiscoveryUI() {
        if (discoverButton) discoverButton.disabled = false;
        if (buttonText) buttonText.textContent = 'Discover';
        updateProgressBar(0);
    }

    // Initial check for discovery progress on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Check discovery progress
        fetch('/discoveryProgress')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.inProgress) {
                    if (discoverButton) discoverButton.disabled = true;
                    if (buttonText) {
                        if (data.progress > 0 && data.progress < 100) {
                            buttonText.textContent = `${data.progress}%`;
                        } else if (data.progress === 0) {
                            buttonText.textContent = 'Starting...';
                        }
                    }
                    updateProgressBar(data.progress);
                    progressInterval = setInterval(getDiscoveryProgress, 500);
                } else {
                    resetDiscoveryUI();
                }
            })
            .catch(error => {
                console.error('Error on initial progress check:', error);
                resetDiscoveryUI();
            });

        // Initialize clear buttons visibility and filter input visibility on load
        document.getElementById('searchTerm')?.dispatchEvent(new Event('input'));
        // Trigger toggleFilterInputs to set initial visibility based on th:selected value
        toggleFilterInputs();
        document.getElementById('minToner')?.dispatchEvent(new Event('input'));
        document.getElementById('minPages')?.dispatchEvent(new Event('input'));
    });

    // Subnet discovery form submission
    document.getElementById('discoverButton')?.closest('div.flex-col').querySelector('button')?.addEventListener('click', function(event) {
        event.preventDefault();
        const subnetPart1 = document.getElementById('subnetPart1').value;
        const subnetPart2 = document.getElementById('subnetPart2').value;
        const subnetPart3 = document.getElementById('subnetPart3').value;
        const subnetPrefix = `${subnetPart1}.${subnetPart2}.${subnetPart3}.`;
        document.getElementById('hiddenSubnetPrefix').value = subnetPrefix;
        document.getElementById('discoverForm').submit();
    });

    // Filter clear buttons logic
    function toggleClearButton(inputId) {
        const input = document.getElementById(inputId);
        const clearButton = document.getElementById('clear' + inputId.charAt(0).toUpperCase() + inputId.slice(1));
        if (input && clearButton) {
            clearButton.style.display = input.value ? 'block' : 'none';
        }
    }

    function clearInput(inputId) {
        document.getElementById(inputId).value = '';
        toggleClearButton(inputId); // Hide the button after clearing
        if (inputId === 'searchTerm') {
            document.getElementById('filterForm').submit(); // Re-submit to clear search results
        }
    }

    function toggleFilterInputs() {
        const filterType = document.getElementById('filterType').value;
        const tonerFilterGroup = document.getElementById('tonerFilterGroup');
        const pagesFilterGroup = document.getElementById('pagesFilterGroup');

        if (tonerFilterGroup) {
            tonerFilterGroup.style.display = (filterType === 'none' || filterType.startsWith('toner')) ? 'block' : 'none';
        }
        if (pagesFilterGroup) {
            pagesFilterGroup.style.display = (filterType === 'none' || filterType.startsWith('pages')) ? 'block' : 'none';
        }

        // Hide specific min/max inputs if a quick filter is selected
        const minTonerInput = document.getElementById('minToner');
        const minPagesInput = document.getElementById('minPages');

        if (minTonerInput) {
            minTonerInput.style.display = (filterType === 'none') ? 'block' : 'none';
        }
        if (minPagesInput) {
            minPagesInput.style.display = (filterType === 'none') ? 'block' : 'none';
        }

        // Ensure clear buttons for minToner and minPages are toggled correctly
        toggleClearButton('minToner');
        toggleClearButton('minPages');
    }

    function clearAllFilters() {
        document.getElementById('searchTerm').value = '';
        document.getElementById('searchType').value = 'name';
        document.getElementById('filterType').value = 'none';
        document.getElementById('minToner').value = '';
        document.getElementById('minPages').value = '';

        toggleClearButton('searchTerm');
        toggleClearButton('minToner');
        toggleClearButton('minPages');
        toggleFilterInputs(); // Ensure display is correct after clearing filters

        document.getElementById('filterForm').submit();
    }


    // New JavaScript for exporting selected printers
    document.getElementById('exportSelectedButton').addEventListener('click', function() { //
        const ipAddressesTextArea = document.getElementById('ipAddressesToExport'); //
        const ipAddressesRaw = ipAddressesTextArea.value; //
        const ipAddresses = ipAddressesRaw.split(/[\n,]/) // Split by newline or comma
                                            .map(ip => ip.trim()) // Trim whitespace from each IP
                                            .filter(ip => ip !== ''); // Remove empty strings

        if (ipAddresses.length === 0) { //
            alert('Please enter at least one IP address to export.'); //
            return; //
        }

        // Join the IP addresses with commas for the request parameter
        const ipAddressesParam = ipAddresses.join(','); //

        // Create a hidden form to submit the request
        const form = document.createElement('form'); //
        form.method = 'POST'; //
        form.action = '/printers/download/excel/selected'; //

        const hiddenInput = document.createElement('input'); //
        hiddenInput.type = 'hidden'; //
        hiddenInput.name = 'ipAddresses'; //
        hiddenInput.value = ipAddressesParam; //
        form.appendChild(hiddenInput); //

        document.body.appendChild(form); //
        form.submit(); //
        document.body.removeChild(form); // Clean up the form after submission
    });

    /*]]>*/
</script>
</body>
</html>